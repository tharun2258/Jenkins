pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
    }

    stages {
        stage('Retrieve Terraform State') {
            steps {
                script {
                    try {
                        copyArtifacts(
                            projectName: 'Terraform-apply-build-artifact',
                            selector: upstream('SUCCESSFUL'), 
                            filter: 'Terraform-Build-Artifact-pipeline/AWS_S3/terraform.tfstate',
                            target: 'Terraform-Use-Build-Artifact-pipeline/AWS_S3'
                        )
                        echo "State file retrieved successfully."
                    } catch (Exception e) {
                        error "Failed to retrieve Terraform state file. Ensure the apply pipeline has run successfully."
                    }
                }
            }
        }

        stage('Terraform Init') {
            steps {
                dir('Terraform-Use-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform init --reconfigure'
                }
            }
        }

        stage('Terraform Destroy') {
            steps {
                dir('Terraform-Use-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform destroy -auto-approve'
                }
            }
        }
    }
}
