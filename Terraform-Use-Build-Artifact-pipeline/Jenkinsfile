pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
    }

    stages {
        stage('Retrieve Terraform State') {
            steps {
                dir('Terraform-Use-Build-Artifact-pipeline/AWS_S3'){
                    copyArtifacts(
                            projectName: 'Terraform-apply-build-artifact',
                            selector: lastSuccessful(), 
                            filter: '**/AWS_S3/terraform.tfstate',
                            target: '.'
                        )
                        echo "State file retrieved successfully."

                        // List the files in the directory to verify
                        bat 'dir /b'

                        bat 'powershell -Command "Get-Content terraform.tfstate -TotalCount 20"'

                        // Print the Terraform state file content
                        bat 'type terraform.tfstate'
                } 
            }
        }
        



        stage('Terraform Init') {
            steps {
                dir('Terraform-Use-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform init --reconfigure'
                }
            }
        }

        stage('Read Terraform State') {
            steps {
              dir('Terraform-Use-Build-Artifact-pipeline/AWS_S3') {
                  bat 'terraform show terraform.tfstate'
                  }
            }
        }
    





        stage('Terraform plan destroy') {
            steps {
                dir('Terraform-Use-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform plan -destroy -out=tfplan'
                }
            }
        }

        stage('Terraform Destroy') {
            steps {
                dir('Terraform-Use-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform apply tfplan -auto-approve'
                }
            }
        }
    }
}
