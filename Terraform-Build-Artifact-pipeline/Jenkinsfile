pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        AWS_BUCKET = "terraform-tfstate-bucket-demo"
        STATE_FILE = "AWS_S3/terraform.tfstate"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                dir('Terraform-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform init -reconfigure -backend-config="bucket=terraform-tfstate-bucket-demo"'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('Terraform-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform plan -out=tfplan'
                }
            }
        }


        

       
       

        stage('Terraform Apply') {
            steps {
                dir('Terraform-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform apply -auto-approve tfplan'
                }
            }
        }
    }



    post{
        failure{
             echo "Terraform deployment failed! Rolling back..."
                    powershell '''
                   
                                        # Step 1: Fetch the second latest version ID of the Terraform state file
                    $PREV_VERSION = aws s3api list-object-versions --bucket $env:AWS_BUCKET --prefix $env:STATE_FILE `
                        --query "Versions | sort_by(@, &LastModified) | reverse()[1].VersionId" --output text 2>$null

                    # Step 2: Debugging output to check if the previous version is found
                    Write-Host "Previous Terraform state version: $PREV_VERSION"

                    # Step 3: Handle cases where no previous version exists
                    if ($PREV_VERSION -eq "None" -or [string]::IsNullOrEmpty($PREV_VERSION)) {
                        Write-Host "‚ùå No previous state version found! Manual recovery required."
                        exit 1
                    }

                    # Step 4: Restore the previous state file from S3
                    aws s3api get-object --bucket $env:AWS_BUCKET --key $env:STATE_FILE --version-id $PREV_VERSION ".\$env:STATE_FILE"

                    # Step 5: Ensure Terraform is in the correct working directory
                    cd "C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\Terraform-apply-build-artifact\\Terraform-Build-Artifact-pipeline\\AWS_S3"

                    # Step 6: Reinitialize Terraform
                    terraform init -reconfigure

                    # Step 7: Apply the restored state
                    terraform apply -auto-approve

                    '''

        }
    }

    // post {
    //     always {
    //         echo "Saving Terraform state file as an artifact..."
    //         archiveArtifacts artifacts: 'Terraform-Build-Artifact-pipeline/AWS_S3/terraform.tfstate', fingerprint: true
    //     }
    // }
}
