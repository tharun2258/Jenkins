pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        AWS_BUCKET = "terraform-tfstate-bucket-demo"
        STATE_FILE = "AWS_S3/terraform.tfstate"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                dir('Terraform-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform init -reconfigure -backend-config="bucket=terraform-tfstate-bucket-demo"'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('Terraform-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform plan -out=tfplan'
                }
            }
        }


        

       
       

        stage('Terraform Apply') {
            steps {
                dir('Terraform-Build-Artifact-pipeline/AWS_S3') {
                    bat 'terraform apply -auto-approve tfplan'
                }
            }
        }
    }



    post{
        failure{
             echo "Terraform deployment failed! Rolling back..."
                    powershell '''
                   
                    Write-Host "üîç Step 1: Fetching previous Terraform state version..."

                    # List all versions of the state file in S3 (Fixed syntax)
                    aws s3api list-object-versions --bucket $env:AWS_BUCKET --prefix $env:STATE_FILE `
                        --query 'Versions | sort_by(@, &LastModified) | reverse()' --output json > versions.json 2>$null

                    # Print the raw JSON output for debugging
                    Write-Host "üìÇ Full version history (latest first):"
                    Get-Content versions.json | Write-Host

                    # Extract the second latest version ID
                    $PREV_VERSION = aws s3api list-object-versions --bucket $env:AWS_BUCKET --prefix $env:STATE_FILE `
                        --query 'Versions | sort_by(@, &LastModified) | reverse()[1].VersionId' --output text 2>$null

                    # Debug: Print the extracted version ID
                    Write-Host "üîé Extracted Previous Version ID: $PREV_VERSION"

                    # Handle cases where no previous version is found
                    if ($PREV_VERSION -eq "None" -or [string]::IsNullOrEmpty($PREV_VERSION)) {
                        Write-Host "‚ùå No previous state version found! Manual recovery required."
                        exit 1
                    }

                    Write-Host "‚úÖ Found Previous Version: $PREV_VERSION"
                    Write-Host "‚¨áÔ∏è Downloading previous state file..."

                    # Step 2: Restore the previous state file from S3
                    aws s3api get-object --bucket $env:AWS_BUCKET --key $env:STATE_FILE --version-id $PREV_VERSION ".\$env:STATE_FILE"

                    # Debug: Confirm the file is downloaded
                    if (Test-Path ".\$env:STATE_FILE") {
                        Write-Host "‚úÖ State file restored successfully!"
                    } else {
                        Write-Host "‚ùå Failed to restore state file. Check S3 permissions."
                        exit 1
                    }

                    # Step 3: Ensure Terraform is in the correct working directory
                    Write-Host "üìÇ Changing to Terraform directory..."
                    cd "C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\Terraform-apply-build-artifact\\Terraform-Build-Artifact-pipeline\\AWS_S3"

                    # Step 4: Reinitialize Terraform
                    Write-Host "üîÑ Reinitializing Terraform..."
                    terraform init -reconfigure

                    # Step 5: Apply the restored state
                    Write-Host "üöÄ Running Terraform Apply..."
                    terraform apply -auto-approve



                    '''

        }
    }

    // post {
    //     always {
    //         echo "Saving Terraform state file as an artifact..."
    //         archiveArtifacts artifacts: 'Terraform-Build-Artifact-pipeline/AWS_S3/terraform.tfstate', fingerprint: true
    //     }
    // }
}
